name: Every 15 Min Wise USD & EUR to CNY Rate Push

on:
  schedule:
    # æ¯ 15 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (0, 15, 30, 45åˆ†)
    # æ³¨æ„ï¼šGitHub å…è´¹ç‰ˆ Actions å¯èƒ½ä¼šæœ‰ 5-10 åˆ†é’Ÿçš„æ’é˜Ÿå»¶è¿Ÿ
    - cron: '*/15 * * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œæµ‹è¯•

jobs:
  push_rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Get Wise Rate and Push
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import os
          from datetime import datetime, timedelta
          from urllib.parse import quote

          def get_wise_rate(source, target):
              """ç›´æ¥ä» Wise æŠ“å–å®æ—¶ä¸­é—´å¸‚åœºæ±‡ç‡"""
              try:
                  url = f"https://wise.com/web-api/v1/rates?source={source}&target={target}"
                  headers = {
                      "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
                      "Cache-Control": "no-cache",
                      "Pragma": "no-cache"
                  }
                  # åŠ ä¸Šéšæœºå‚æ•°é˜²æ­¢ CDN ç¼“å­˜
                  params = {"_t": datetime.now().timestamp()}
                  resp = requests.get(url, headers=headers, params=params, timeout=15)
                  # Wise è¿”å›çš„æ˜¯åˆ—è¡¨ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ 
                  return resp.json()[0]['rate']
              except Exception as e:
                  print(f"Wise {source}/{target} æŠ“å–å¼‚å¸¸: {e}")
                  return None

          # 1. å‡†å¤‡å‚æ•°
          bark_key = os.environ.get('BARK_KEY')
          if not bark_key:
              print("é”™è¯¯: è¯·åœ¨ GitHub Secrets ä¸­é…ç½® BARK_KEY")
              exit(1)

          # è·å–åŒ—äº¬æ—¶é—´ (UTC+8)
          bj_time = (datetime.utcnow() + timedelta(hours=8)).strftime("%H:%M")

          # 2. è·å–æ•°æ®
          usd_cny = get_wise_rate("USD", "CNY")
          eur_cny = get_wise_rate("EUR", "CNY")

          # 3. æ„å»ºæ¨é€å†…å®¹
          if usd_cny and eur_cny:
              usd_val = round(usd_cny, 4)
              eur_val = round(eur_cny, 4)
              title = f"Wise æ±‡ç‡æ›´æ–° [{bj_time}]"
              body = f"ğŸ‡ºğŸ‡¸ USD/CNY: {usd_val}\nğŸ‡ªğŸ‡º EUR/CNY: {eur_val}"
              print(f"æŠ“å–æˆåŠŸ: USD={usd_val}, EUR={eur_val}")
          else:
              title = "æ±‡ç‡æŠ“å–å¤±è´¥"
              body = "Wise æ¥å£æš‚æ—¶æ— æ³•è¿æ¥ï¼Œè¯·æ£€æŸ¥ Action æ—¥å¿—"

          # 4. æ‰§è¡Œæ¨é€
          encoded_title = quote(title)
          encoded_body = quote(body)
          
          # è¯¦è§£ï¼š
          # icon: ä½¿ç”¨ Wise å®˜æ–¹å›¾æ ‡
          # group: åˆ†ç»„ä¸º Finance
          # autoCopy: è‡ªåŠ¨å¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿
          # sound: ä½¿ç”¨ anticipate è¿™ç§æ¸…çˆ½çš„æç¤ºéŸ³
          bark_url = f"https://api.day.app/{bark_key}?title={encoded_title}&body={encoded_body}&icon=https://wise.com/images/favicons/apple-touch-icon-180x180.png&group=Finance&autoCopy=1&sound=anticipate"
          
          try:
              r = requests.get(bark_url, timeout=10)
              if r.status_code == 200:
                  print("Bark æ¨é€æˆåŠŸ")
              else:
                  print(f"Bark æ¨é€å¼‚å¸¸ï¼ŒçŠ¶æ€ç : {r.status_code}")
          except Exception as e:
              print(f"ç½‘ç»œè¯·æ±‚é”™è¯¯: {e}")
          EOF
