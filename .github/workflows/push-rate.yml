name: Stable Real-time Rate Push

on:
  schedule:
    # æ¯ 15 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/15 * * * *'
  workflow_dispatch: 

jobs:
  push_rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Get Rate and Push
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
          EX_KEY: ${{ secrets.EX_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import os
          from datetime import datetime, timedelta
          from urllib.parse import quote

          def get_rate():
              api_key = os.environ.get('EX_KEY')
              # ä½¿ç”¨ä½ æµ‹è¯•æˆåŠŸçš„é‚£ä¸ªæ¥å£åœ°å€
              url = f"http://api.exchangerate.host/live?access_key={api_key}&source=USD&currencies=CNY,EUR"
              try:
                  resp = requests.get(url, timeout=20)
                  data = resp.json()
                  if data.get('success'):
                      # è¯¥æ¥å£è¿”å›çš„æ±‡ç‡åœ¨ quotes å­—æ®µä¸‹
                      quotes = data['quotes']
                      usd_cny = quotes.get('USDCNY')
                      eur_usd_rate = quotes.get('USDEUR')
                      
                      # è®¡ç®— EUR/CNY: (1 / USDEUR) * USDCNY
                      eur_cny = usd_cny / eur_usd_rate if eur_usd_rate else 0
                      return round(usd_cny, 4), round(eur_cny, 4)
                  else:
                      print(f"API æŠ¥é”™è¯¦æƒ…: {data}")
              except Exception as e:
                  print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
              return None, None

          bark_key = os.environ.get('BARK_KEY')
          bj_time = (datetime.utcnow() + timedelta(hours=8)).strftime("%H:%M")

          usd, eur = get_rate()

          if usd and eur:
              title = f"æ±‡ç‡å®æ—¶æ’­æŠ¥ [{bj_time}]"
              body = f"ğŸ‡ºğŸ‡¸ USD/CNY: {usd}\nğŸ‡ªğŸ‡º EUR/CNY: {eur}"
              print(f"æŠ“å–æˆåŠŸ: USD={usd}, EUR={eur}")
          else:
              title = "æ±‡ç‡è·å–å¤±è´¥"
              body = "API å“åº”å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ Actions æ—¥å¿—ä¸­çš„æŠ¥é”™ä¿¡æ¯"

          encoded_title = quote(title)
          encoded_body = quote(body)
          
          # æ¨é€è‡³ Bark
          bark_url = f"https://api.day.app/{bark_key}?title={encoded_title}&body={encoded_body}&icon=https://api.iconify.design/fc:currency-exchange.svg&group=Finance&autoCopy=1"
          
          try:
              requests.get(bark_url, timeout=10)
              print("æ¨é€å·²å‘é€è‡³ Bark")
          except Exception as e:
              print(f"æ¨é€å‡ºé”™: {e}")
          EOF
