name: Robust Real time Rate Push

on:
  schedule:
    # æ¯ 15 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (0, 15, 30, 45åˆ†)
    # æç¤ºï¼šGitHub Actions å…è´¹ç‰ˆå¯èƒ½ä¼šæœ‰å‡ åˆ†é’Ÿçš„éšæœºæ’é˜Ÿå»¶è¿Ÿ
    - cron: '*/15 * * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®ç«‹å³æµ‹è¯•

jobs:
  push_rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Get Rate and Push
        env:
          # è¿™é‡Œå¿…é¡»ä¸ä½ åœ¨ Settings -> Secrets ä¸­è®¾ç½®çš„åå­—å®Œå…¨ä¸€è‡´
          BARK_KEY: ${{ secrets.BARK_KEY }}
          EX_KEY: ${{ secrets.EX_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import os
          from datetime import datetime, timedelta
          from urllib.parse import quote

          def get_rate():
              api_key = os.environ.get('EX_KEY')
              # ä½¿ç”¨ ExchangeRate-API è·å–ä»¥ USD ä¸ºåŸºå‡†çš„å®æ—¶æ±‡ç‡
              url = f"https://v6.exchangerate-api.com/v6/{api_key}/latest/USD"
              try:
                  resp = requests.get(url, timeout=20)
                  data = resp.json()
                  if data.get('result') == 'success':
                      rates = data['conversion_rates']
                      usd_cny = rates.get('CNY')
                      eur_usd = rates.get('EUR')
                      # æ¢ç®— EUR å…‘ CNY: (1 / EURå…‘USD) * USDå…‘CNY
                      eur_cny = usd_cny / eur_usd if eur_usd else 0
                      return round(usd_cny, 4), round(eur_cny, 4)
                  else:
                      print(f"API è¿”å›é”™è¯¯: {data.get('error-type')}")
              except Exception as e:
                  print(f"è¯·æ±‚å¤±è´¥: {e}")
              return None, None

          # 1. åˆå§‹åŒ–å˜é‡
          bark_key = os.environ.get('BARK_KEY')
          # è·å–åŒ—äº¬æ—¶é—´ (UTC+8) ç”¨äºæ ‡é¢˜æ˜¾ç¤ºï¼Œæ–¹ä¾¿ç¡®è®¤æ¨é€æ–°é²œåº¦
          bj_time = (datetime.utcnow() + timedelta(hours=8)).strftime("%H:%M")

          # 2. è·å–æ•°æ®
          usd, eur = get_rate()

          # 3. å‡†å¤‡æ¨é€å†…å®¹
          if usd and eur:
              title = f"å®æ—¶æ±‡ç‡æ›´æ–° [{bj_time}]"
              body = f"ğŸ‡ºğŸ‡¸ USD/CNY: {usd}\nğŸ‡ªğŸ‡º EUR/CNY: {eur}"
              print(f"æˆåŠŸè·å–: USD={usd}, EUR
