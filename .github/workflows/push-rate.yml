name: Hourly USD & EUR to CNY Rate Push

on:
  schedule:
    - cron: '0 * * * *'          # UTC 每小时整点 ≈ 北京时间每小时整点（延迟小）
  workflow_dispatch:             # 支持手动测试

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Push USD & EUR to CNY Rate
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import json
          import os

          bark_key = os.environ.get('BARK_KEY')
          if not bark_key:
              print("BARK_KEY 未注入，检查 GitHub Secrets")
              exit(1)

          try:
              api_url = "https://open.er-api.com/v6/latest/USD"
              resp = requests.get(api_url, timeout=10)
              data = resp.json()

              if data.get('result') == 'success':
                  rates = data['rates']
                  usd_cny = round(rates['CNY'], 4)
                  eur_cny = round(rates['EUR'] ** -1 * rates['CNY'], 4)  # EUR to CNY = (1/EUR_USD) * USD_CNY
                  title = "美元 & 欧元汇率更新"
                  body = f"1 USD = {usd_cny} CNY\n1 EUR = {eur_cny} CNY"
              else:
                  title = "汇率 API 异常"
                  body = "获取失败，请稍后重试"
          except Exception as e:
              title = "脚本错误"
              body = f"异常: {str(e)[:60]}"

          # Bark 推送（多行内容用 %0A 换行，group 分组，autoCopy 自动复制）
          sound = "minuet"
          bark_url = f"https://api.day.app/{bark_key}/{body}?title={title}&sound={sound}&badge=1&group=汇率&autoCopy=1"
          requests.get(bark_url)
          print("推送已发送:", title, "-", body)
          EOF
