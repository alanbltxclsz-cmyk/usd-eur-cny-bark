name: Hourly USD to CNY Rate Push   # <-- 第一行必须是 name: 或其他键，不能是 -

on:
  schedule:
    - cron: '0 * * * *'          # 这里才有 -
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Push USD/CNY Rate
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import json
          import os

          bark_key = os.environ.get('BARK_KEY')
          if not bark_key:
              title = "Secret 缺失"
              body = "BARK_KEY 未注入"
          else:
              try:
                  api_url = "https://open.er-api.com/v6/latest/USD"
                  resp = requests.get(api_url, timeout=10)
                  data = resp.json()
                  
                  if data.get('result') == 'success':
                      cny = data['rates']['CNY']
                      rate = round(cny, 4)
                      title = "美元汇率更新"
                      body = f"1 USD = {rate} CNY"
                  else:
                      title = "API 失败"
                      body = "获取失败"
              except Exception as e:
                  title = "脚本异常"
                  body = f"错误: {str(e)[:80]}"
          
          sound = "minuet"
          if bark_key:
              bark_url = f"https://api.day.app/{bark_key}/{body}?title={title}&sound={sound}&badge=1"
              requests.get(bark_url)
          EOF
