name: Hourly USD & EUR to CNY Rate Push

on:
  schedule:
    - cron: '15 * * * *'         # UTC 每小时15分 ≈ 北京时间每小时23分
  workflow_dispatch:             # 支持手动立即测试

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Push USD & EUR to CNY Rate
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import json
          import os
          from urllib.parse import quote

          bark_key = os.environ.get('BARK_KEY')
          if not bark_key:
              print("BARK_KEY 未注入，检查 GitHub Secrets")
              exit(1)

          try:
              api_url = "https://open.er-api.com/v6/latest/USD"
              resp = requests.get(api_url, timeout=10)
              data = resp.json()

              if data.get('result') == 'success':
                  rates = data['rates']
                  usd_cny = round(rates.get('CNY', 0), 4)
                  eur_usd = rates.get('EUR', 0)
                  eur_cny = round(rates['CNY'] / eur_usd, 4) if eur_usd != 0 else 0
                  title = "美元 & 欧元汇率更新"
                  body = f"1 USD = {usd_cny} CNY\n1 EUR = {eur_cny} CNY"
              else:
                  title = "汇率 API 异常"
                  body = "获取失败，请稍后重试"
          except Exception as e:
              title = "脚本错误"
              body = f"异常: {str(e)[:60]}"

          encoded_title = quote(title)
          encoded_body = quote(body)

          sound = "minuet"
          bark_url = f"https://api.day.app/{bark_key}/{encoded_body}?title={encoded_title}&sound={sound}&badge=1&group=汇率&autoCopy=1"
          resp = requests.get(bark_url)
          print("推送请求发送，状态码:", resp.status_code)
          print("标题:", title)
          print("内容:", body)
          EOF
